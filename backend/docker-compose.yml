services:
  postgres:
    image: postgres:16
    container_name: esm-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_DEBUG: ${POSTGRES_DEBUG}
      POSTGRES_LOG_STATEMENT: ${POSTGRES_LOG_STATEMENT}
      POSTGRES_LOG_DURATION: ${POSTGRES_LOG_DURATION}
    command:
      [
        "postgres",
        "-c",
        "log_statement=${POSTGRES_LOG_STATEMENT}",
        "-c",
        "log_duration=${POSTGRES_LOG_DURATION}",
        "-c",
        "log_min_duration_statement=${POSTGRES_LOG_MIN_DURATION_STATEMENT:-1}"
      ]
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    container_name: esm-redis
    ports:
      - "${REDIS_PORT}:6379"

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: esm-kafka
    ports:
      - "${KAFKA_PORT}:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: controller,broker
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://${KAFKA_ADVERTISED_HOST}:${KAFKA_PORT}
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      KAFKA_CLUSTER_ID: ${KAFKA_KRAFT_CLUSTER_ID}
    volumes:
      - kafka_data:/var/lib/kafka/data

  minio:
    image: minio/minio:RELEASE.2024-01-31T20-20-33Z
    container_name: esm-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "${MINIO_PORT}:9000"
      - "${MINIO_CONSOLE_PORT}:9001"
    volumes:
      - minio_data:/data

  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: esm-api
    env_file:
      - .env
    ports:
      - "${PORT}:3000"
    depends_on:
      - postgres
      - kafka
      - redis
      - minio

  telemetry-worker:
    build:
      context: ./workers-python/telemetry-worker
      dockerfile: Dockerfile
    container_name: esm-telemetry-worker
    env_file:
      - workers-python/telemetry-worker/.env
    profiles: ["workers"]
    depends_on:
      - kafka
      - api

  erp-worker:
    build:
      context: ./workers-python/erp-worker
      dockerfile: Dockerfile
    container_name: esm-erp-worker
    env_file:
      - workers-python/erp-worker/.env
    profiles: ["workers"]
    depends_on:
      - kafka
      - api

  webhook-worker:
    build:
      context: ./workers-python/webhook
      dockerfile: Dockerfile
    container_name: esm-webhook-worker
    env_file:
      - workers-python/webhook/.env
    profiles: ["workers"]
    depends_on:
      - api

  migrations-runner:
    image: python:3.11-slim
    container_name: esm-migrations-runner
    working_dir: /app
    volumes:
      - ./:/app
    env_file:
      - .env
    profiles: ["migrations"]
    depends_on:
      - postgres
    command: >
      sh -c "pip install -r workers-python/migrations/requirements.txt
      && python workers-python/migrations/run_migrations.py upgrade"

volumes:
  pg_data:
  kafka_data:
  minio_data:
